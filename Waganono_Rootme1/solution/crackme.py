# python port of Waganono's "Root Me #1"

from sys import argv
from struct import unpack
from whirlpool import Whirlpool

n=0xB2D0FD991BDDC9E137CE7E21F04B231A3899445CC8FA6C6364BBABBED816AE77AAFFE2FC6329F64B9A47EDAACEFF05D6EDA9
p=0xB37AD654A32D2D93F7D8FB81C999CEBB621B6C234666F3196B
q=0xFF0DBD838D1D7F92A972DA9857F35C71ABFD20F4DC00BAB63B

# 2500 entries from 0x0042A090
# 50x50 matrix?
matrix = [213, 116, 184, 141, 84, 84, 69, 117, 215, 165, 142, 59, 24, 232, 243, 66,34, 58, 40, 193, 234, 19, 63, 62, 168, 184, 114, 181, 254, 171, 216, 81,30, 143, 222, 242, 228, 34, 102, 57, 71, 115, 244, 95, 91, 230, 32, 253,160, 73, 61, 137, 220, 124, 70, 2, 179, 55, 54, 177, 226, 14, 1, 127,157, 95, 112, 256, 0, 85, 56, 71, 200, 172, 167, 34, 145, 70, 159, 48,14, 220, 56, 235, 87, 254, 108, 9, 180, 163, 57, 149, 177, 187, 147, 205,25, 130, 76, 25, 215, 3, 97, 159, 175, 135, 64, 192, 205, 223, 111, 220,186, 39, 69, 144, 36, 177, 154, 217, 211, 82, 237, 2, 12, 256, 208, 165,129, 155, 62, 88, 158, 30, 118, 77, 165, 53, 140, 241, 20, 251, 75, 77,33, 15, 222, 198, 64, 247, 29, 18, 200, 9, 21, 213, 8, 100, 249, 9,255, 54, 97, 156, 84, 86, 104, 120, 139, 244, 233, 30, 110, 51, 236, 143,67, 72, 212, 131, 190, 241, 20, 133, 122, 41, 89, 1, 12, 210, 10, 10,7, 235, 38, 220, 64, 142, 83, 75, 1, 59, 233, 111, 239, 212, 254, 177,155, 81, 51, 88, 65, 199, 222, 187, 241, 182, 189, 253, 135, 199, 135, 143,178, 173, 106, 113, 58, 60, 188, 187, 248, 165, 41, 230, 248, 167, 150, 147,248, 72, 235, 56, 14, 71, 115, 126, 254, 175, 251, 3, 245, 129, 17, 37,173, 251, 151, 102, 55, 210, 33, 46, 246, 74, 147, 238, 241, 40, 256, 103,112, 234, 31, 254, 177, 146, 124, 174, 64, 246, 48, 52, 118, 66, 90, 34,60, 112, 7, 243, 65, 40, 32, 55, 115, 179, 164, 227, 90, 163, 202, 73,11, 233, 71, 188, 250, 66, 233, 57, 55, 25, 237, 44, 91, 198, 206, 151,181, 213, 138, 247, 254, 41, 173, 240, 92, 208, 81, 182, 114, 26, 256, 125,2, 198, 185, 252, 7, 161, 180, 190, 57, 32, 105, 148, 101, 54, 171, 26,138, 180, 16, 6, 92, 60, 246, 184, 11, 71, 238, 253, 225, 108, 249, 228,49, 177, 94, 184, 210, 146, 245, 10, 178, 93, 159, 22, 18, 201, 48, 156,124, 192, 163, 216, 123, 23, 15, 5, 222, 253, 1, 191, 104, 251, 33, 24,42, 255, 208, 252, 144, 67, 6, 65, 160, 36, 216, 178, 237, 135, 205, 232,199, 111, 62, 193, 6, 77, 199, 228, 201, 200, 162, 176, 65, 66, 200, 108,65, 22, 103, 209, 89, 237, 146, 120, 16, 233, 169, 124, 111, 118, 227, 181,100, 33, 118, 106, 238, 60, 78, 54, 131, 111, 230, 197, 178, 45, 48, 243,67, 151, 66, 28, 3, 212, 19, 19, 188, 189, 15, 171, 178, 242, 223, 21,146, 84, 256, 256, 15, 205, 53, 147, 187, 154, 87, 108, 70, 6, 222, 9,28, 160, 37, 31, 115, 184, 51, 175, 116, 194, 217, 165, 179, 183, 58, 197,11, 185, 196, 26, 133, 120, 44, 63, 145, 131, 43, 216, 137, 136, 225, 37,39, 133, 68, 155, 60, 119, 201, 48, 184, 32, 213, 107, 215, 142, 47, 97,70, 114, 252, 203, 234, 39, 138, 122, 42, 181, 81, 50, 60, 177, 87, 228,53, 156, 254, 114, 146, 198, 162, 74, 101, 246, 52, 59, 132, 99, 28, 202,213, 151, 20, 61, 190, 29, 183, 103, 210, 136, 154, 141, 56, 241, 240, 238,11, 237, 95, 158, 49, 128, 103, 150, 245, 155, 81, 120, 125, 109, 194, 209,3, 85, 13, 64, 114, 67, 168, 195, 74, 193, 207, 2, 48, 191, 240, 60,171, 206, 89, 221, 77, 192, 242, 65, 218, 66, 57, 86, 46, 122, 166, 49,78, 179, 242, 63, 117, 24, 1, 192, 217, 79, 65, 8, 141, 48, 68, 184,254, 28, 19, 202, 91, 4, 10, 52, 71, 195, 9, 117, 188, 175, 38, 9,225, 151, 72, 86, 175, 201, 149, 135, 152, 214, 14, 36, 133, 83, 220, 130,239, 110, 75, 74, 115, 213, 126, 57, 152, 7, 174, 211, 53, 83, 221, 22,234, 164, 236, 23, 237, 256, 29, 132, 213, 44, 39, 89, 255, 131, 90, 237,241, 36, 54, 99, 249, 52, 156, 15, 187, 202, 227, 240, 156, 62, 133, 5,226, 112, 28, 206, 111, 58, 209, 195, 102, 249, 155, 100, 123, 116, 208, 235,152, 6, 78, 16, 186, 105, 31, 116, 178, 1, 99, 78, 63, 104, 211, 161,216, 239, 110, 199, 168, 191, 137, 13, 183, 164, 241, 177, 23, 64, 155, 47,198, 104, 63, 127, 210, 94, 114, 2, 224, 84, 80, 158, 188, 34, 62, 148,145, 44, 218, 56, 235, 226, 198, 32, 133, 53, 209, 28, 117, 107, 75, 58,212, 138, 56, 36, 232, 170, 38, 70, 255, 247, 229, 186, 152, 34, 205, 168,206, 166, 225, 184, 136, 37, 216, 140, 218, 39, 168, 79, 147, 243, 8, 230,124, 65, 9, 228, 235, 175, 41, 104, 165, 13, 162, 189, 176, 110, 100, 125,148, 68, 181, 155, 233, 11, 38, 195, 51, 207, 145, 69, 193, 153, 42, 189,218, 179, 160, 68, 97, 72, 43, 134, 86, 205, 66, 133, 187, 166, 1, 78,106, 53, 233, 82, 65, 142, 20, 244, 92, 36, 56, 157, 190, 226, 217, 22,148, 120, 218, 116, 63, 5, 250, 149, 210, 59, 25, 140, 226, 155, 89, 203,208, 193, 28, 144, 79, 177, 131, 42, 213, 58, 199, 17, 27, 159, 40, 175,150, 1, 35, 214, 134, 156, 234, 88, 216, 131, 99, 56, 29, 60, 2, 108,253, 158, 253, 75, 78, 255, 118, 163, 57, 188, 180, 84, 219, 91, 131, 240,221, 37, 197, 98, 193, 46, 186, 23, 177, 157, 79, 77, 217, 209, 185, 84,111, 52, 31, 60, 51, 20, 94, 236, 208, 18, 191, 41, 237, 193, 25, 201,230, 93, 43, 38, 139, 100, 61, 187, 0, 12, 7, 88, 221, 193, 173, 203,116, 204, 135, 38, 95, 229, 17, 46, 118, 80, 88, 99, 16, 241, 43, 118,77, 86, 27, 88, 187, 88, 18, 58, 228, 26, 18, 64, 219, 191, 10, 206,9, 145, 245, 104, 246, 5, 21, 107, 213, 237, 206, 101, 221, 121, 219, 170,207, 246, 1, 8, 205, 19, 195, 48, 45, 213, 112, 135, 18, 250, 85, 27,10, 73, 2, 256, 206, 23, 106, 163, 132, 184, 135, 224, 48, 97, 137, 255,214, 138, 135, 33, 158, 201, 81, 74, 157, 64, 81, 175, 58, 37, 73, 68,110, 75, 67, 187, 226, 44, 221, 229, 228, 99, 197, 19, 67, 77, 146, 152,87, 24, 186, 116, 225, 138, 190, 253, 203, 142, 42, 4, 179, 115, 72, 160,61, 10, 91, 158, 54, 183, 131, 26, 26, 199, 173, 221, 147, 62, 117, 234,214, 46, 93, 53, 55, 155, 49, 1, 168, 91, 133, 91, 77, 76, 251, 138,86, 213, 168, 12, 140, 170, 166, 166, 112, 82, 130, 2, 145, 118, 108, 102,164, 72, 156, 91, 98, 76, 92, 10, 168, 97, 101, 245, 173, 223, 255, 131,180, 166, 143, 63, 79, 52, 100, 62, 5, 101, 192, 150, 220, 43, 124, 255,244, 23, 89, 213, 99, 53, 223, 138, 21, 195, 127, 194, 33, 125, 196, 213,162, 82, 147, 112, 5, 118, 174, 11, 219, 109, 32, 53, 24, 156, 52, 139,179, 12, 95, 150, 193, 190, 31, 214, 256, 29, 23, 32, 25, 219, 245, 187,173, 6, 42, 49, 124, 87, 60, 215, 197, 93, 11, 92, 120, 191, 231, 43,75, 197, 64, 11, 130, 95, 97, 130, 253, 248, 162, 21, 81, 22, 80, 254,28, 250, 175, 24, 81, 235, 239, 149, 199, 250, 241, 191, 185, 86, 105, 3,26, 169, 142, 157, 135, 110, 30, 131, 101, 63, 24, 183, 85, 104, 51, 242,97, 226, 9, 49, 76, 119, 198, 146, 240, 182, 80, 168, 11, 185, 42, 38,225, 56, 66, 104, 166, 224, 106, 139, 30, 130, 193, 244, 105, 115, 229, 74,85, 109, 123, 32, 99, 65, 49, 82, 118, 130, 122, 130, 186, 164, 39, 155,91, 233, 130, 129, 200, 107, 11, 230, 238, 75, 217, 214, 190, 60, 31, 146,40, 26, 178, 139, 91, 99, 222, 209, 229, 87, 210, 29, 122, 120, 55, 85,96, 56, 214, 39, 164, 96, 141, 16, 171, 101, 230, 104, 33, 133, 251, 73,159, 43, 213, 121, 142, 49, 201, 242, 7, 155, 15, 0, 146, 198, 85, 243,255, 170, 153, 162, 9, 37, 178, 180, 10, 22, 28, 43, 155, 22, 116, 57,65, 200, 49, 79, 120, 251, 64, 127, 20, 207, 256, 166, 149, 84, 23, 147,255, 48, 180, 135, 85, 101, 59, 223, 123, 87, 9, 22, 237, 254, 207, 173,68, 128, 252, 189, 122, 60, 187, 142, 138, 186, 179, 30, 142, 74, 48, 11,122, 228, 146, 207, 72, 205, 174, 67, 163, 54, 89, 143, 51, 167, 60, 120,38, 183, 180, 31, 114, 110, 44, 253, 168, 224, 26, 53, 41, 75, 64, 163,46, 210, 241, 247, 30, 29, 57, 193, 84, 17, 80, 6, 55, 11, 254, 94,194, 177, 253, 52, 159, 41, 48, 70, 8, 202, 251, 177, 20, 58, 211, 195,139, 66, 185, 40, 96, 242, 234, 51, 130, 185, 57, 185, 196, 183, 150, 4,231, 147, 184, 133, 188, 103, 74, 67, 49, 68, 115, 197, 254, 69, 135, 8,135, 191, 48, 102, 47, 25, 153, 177, 210, 82, 234, 20, 136, 127, 25, 110,17, 80, 244, 76, 184, 189, 14, 233, 1, 129, 173, 255, 69, 180, 6, 76,242, 183, 178, 33, 79, 203, 81, 33, 28, 58, 181, 164, 186, 77, 17, 74,158, 132, 22, 85, 65, 164, 61, 194, 37, 105, 63, 234, 156, 198, 53, 142,124, 103, 175, 203, 49, 127, 107, 77, 186, 32, 112, 243, 237, 0, 188, 138,133, 210, 94, 69, 118, 26, 134, 26, 132, 197, 3, 31, 138, 185, 44, 5,31, 219, 80, 80, 90, 187, 28, 147, 90, 140, 133, 71, 140, 64, 80, 144,146, 175, 84, 7, 201, 218, 161, 204, 159, 164, 236, 168, 220, 23, 174, 251,114, 254, 202, 75, 55, 230, 93, 146, 241, 97, 217, 253, 161, 40, 140, 178,86, 96, 185, 31, 185, 217, 235, 87, 253, 85, 127, 216, 237, 44, 82, 222,169, 27, 168, 224, 129, 4, 241, 113, 101, 201, 109, 133, 113, 121, 55, 199,217, 111, 101, 145, 72, 208, 104, 68, 36, 231, 155, 144, 146, 237, 109, 186,136, 20, 24, 8, 152, 9, 121, 253, 210, 231, 1, 194, 223, 184, 8, 183,38, 109, 199, 238, 188, 174, 177, 225, 19, 76, 240, 36, 184, 93, 222, 63,241, 247, 199, 137, 256, 64, 4, 80, 166, 133, 146, 132, 60, 154, 186, 99,134, 256, 208, 66, 174, 129, 162, 64, 76, 145, 101, 3, 109, 66, 195, 94,184, 137, 102, 54, 72, 234, 135, 238, 111, 24, 241, 171, 49, 41, 141, 54,169, 93, 120, 86, 222, 153, 150, 41, 42, 122, 172, 22, 189, 110, 244, 244,248, 89, 42, 63, 195, 48, 173, 49, 200, 28, 91, 249, 198, 233, 46, 110,69, 38, 67, 34, 62, 88, 203, 104, 211, 118, 255, 14, 100, 242, 1, 91,203, 43, 25, 141, 91, 69, 61, 34, 226, 152, 154, 167, 128, 72, 148, 68,238, 215, 230, 43, 46, 176, 19, 128, 166, 17, 142, 9, 2, 15, 228, 205,186, 253, 217, 149, 194, 21, 183, 163, 45, 209, 201, 44, 24, 220, 113, 133,178, 86, 176, 95, 6, 195, 95, 43, 212, 237, 52, 86, 123, 23, 162, 53,147, 123, 202, 212, 15, 256, 246, 60, 208, 190, 105, 103, 24, 89, 236, 202,175, 156, 169, 52, 222, 135, 95, 178, 243, 18, 7, 110, 41, 40, 163, 60,163, 236, 15, 50, 235, 5, 238, 58, 66, 214, 161, 91, 46, 12, 164, 222,39, 204, 17, 4, 82, 241, 53, 69, 2, 188, 179, 172, 229, 213, 232, 6,192, 118, 56, 170, 251, 166, 99, 61, 123, 4, 23, 170, 144, 187, 6, 54,6, 23, 186, 88, 135, 111, 28, 138, 42, 78, 53, 142, 34, 156, 149, 97,17, 76, 139, 12, 242, 238, 201, 237, 113, 224, 150, 128, 154, 156, 182, 31,50, 240, 120, 186, 94, 19, 195, 136, 98, 248, 150, 3, 147, 42, 229, 35,246, 111, 47, 103, 220, 119, 83, 77, 86, 104, 76, 112, 131, 2, 143, 52,242, 134, 109, 207, 154, 47, 86, 252, 166, 236, 126, 184, 149, 98, 220, 10,209, 138, 113, 173, 1, 67, 121, 87, 171, 197, 70, 173, 70, 214, 225, 183,91, 78, 133, 245, 253, 91, 111, 163, 198, 238, 90, 91, 79, 181, 229, 160,63, 213, 204, 192, 23, 68, 150, 65, 136, 221, 238, 207, 178, 206, 4, 12,155, 138, 129, 152, 229, 240, 58, 170, 221, 19, 132, 172, 201, 232, 75, 7,188, 150, 70, 211, 89, 220, 19, 225, 184, 128, 46, 105, 78, 51, 246, 104,60, 118, 256, 160, 101, 185, 201, 194, 205, 205, 237, 149, 180, 55, 27, 112,76, 97, 194, 165, 60, 85, 133, 245, 213, 51, 221, 162, 230, 210, 10, 33,71, 137, 64, 44, 66, 8, 109, 14, 213, 89, 34, 137, 15, 61, 120, 91,29, 57, 256, 217, 142, 3, 205, 99, 54, 41, 132, 155, 251, 142, 188, 194,23, 123, 238, 217, 132, 90, 231, 88, 50, 136, 96, 65, 68, 216, 156, 97,17, 26, 57, 30, 29, 134, 0, 212, 175, 133, 110, 40, 146, 170, 234, 169,36, 86, 129, 39, 47, 231, 128, 97, 110, 95, 33, 178, 55, 189, 146, 200,215, 75, 230, 116, 209, 102, 71, 255, 235, 52, 38, 124, 93, 144, 165, 1,230, 37, 40, 149, 140, 168, 246, 121, 7, 23, 43, 190, 83, 60, 133, 170,135, 234, 157, 215, 79, 228, 213, 185, 151, 123, 53, 245, 10, 89, 246, 111,254, 157, 3, 137, 69, 121, 2, 204, 15, 173, 8, 226, 233, 12, 139, 112,117, 39, 70, 197, 138, 155, 253, 161, 21, 177, 20, 31, 9, 137, 13, 7,37, 17, 144, 106, 9, 17, 181, 24, 190, 60, 250, 38, 72, 4, 21, 190,171, 91, 1, 181, 117, 254, 85, 138, 175, 105, 40, 55, 242, 54, 190, 22,199, 206, 0, 208, 223, 52, 103, 28, 113, 224, 66, 185, 99, 87, 118, 14,49, 247, 66, 167, 245, 151, 176, 34, 127, 217, 217, 112, 142, 151, 5, 212,100, 133, 34, 66];

def legendre(a,p):
    if (a%p)==0:
        return 0
    if pow(a,(p-1)/2,p)==1:
        return 1
    return -1

def bignum_from_name(name):
    bn_name=0
    m=Whirlpool()
    m.update(name)
    for byte in m.digest():
        bn_name = (bn_name*256 + unpack("B", byte)[0]) % n
    while (legendre(bn_name,p)!=1) or (legendre(bn_name,q)!=1):
        bn_name=bn_name+1
    return bn_name

def decode_key(k):
    result=0
    lookup="QZM9GYLDR4BKS6PH7FX3TNW1A20J5C8VOEIU"
    for c in k:
        result=(result*36)+lookup.find(c)
    return result

def from_base257(a):
    result=0
    for n in reversed(a):
        result=257*result+n
    return result

def to_base257(n):
    result=[]
    while(n):
        quotient = n/257
        product = quotient*257
        result.append(n - product)
        n = quotient
    return result

def list_in_hex(l):
    for n in l:
        print '%X' % n,
    print ''

#------------------------------------------------------------------------------
# main()
#------------------------------------------------------------------------------
ok=0

name = 'waganono'
key = '8CO5YK0C9EWM36ELDD49OJQXXOH1QRACPIZI2WH7W9E27AP24E4BLSO1WBTT91VSD8UNA6EP2UANRP6AHIMN3F0RUGA8RD3O19DSZH6A7XQRA0CGS6S8'
if len(argv) > 2:
    name = argv[1]
    key = argv[2]

# string -> bignum
key = decode_key(key)
print "key as bignum: %X" % key
# bignum -> base 257
key = to_base257(key)
print "key as base 257:",
list_in_hex(key)
print ''
# base 257 -> base 257 (first (LSB side) 50 bytes (400 bits) of key using matrix transformation)
mproduct = []
for h in range(50):
    sum = 0
    for i in range(50):
        sum = sum + (key[i] * matrix[50*h+i])
    mproduct.append(sum % 257)
for h in range(50):
    key[h] = mproduct[h]
print "key as base 257 (after transform):",
list_in_hex(key)
print ''

# base 257 -> bignum
key = from_base257(key)
print "key as number again: %X" % key
# split this bignum into bits above 400 and bits below 400
key_top = key >> 400
key_bot = key & (2**400-1)
print "key_top: %X" % key_top
print "key_bot: %X" % key_bot
# top must be factor of n
if (n%key_top==0):
    # bottom must be plaintext
    ciphertext = bignum_from_name(name)
    print "ciphertext: %X" % ciphertext
    if pow(key_bot,2,n) == ciphertext:
        ok=1
    else:
        print "square root problem!"
else:
    print "factor problem!"

if ok==1:
    print 'yes'
else:    
    print 'no'


